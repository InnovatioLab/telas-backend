# =====================================
# ğŸ³ Makefile para ambiente Docker Compose
# =====================================

# UID e GID do usuÃ¡rio local (garante permissÃµes corretas nos volumes)
UID := $(shell id -u)
GID := $(shell id -g)
USER := $(shell whoami)

# DiretÃ³rios de volumes locais
VOLUMES = loki_data prometheus_data grafana_data minio_data

# =====================================
# ğŸ§© Comandos principais
# =====================================

## Sobe todos os containers (garante permissÃµes corretas antes)
up: fix-perms
	@echo "ğŸ”¼ Subindo containers..."
	@export UID=$(UID) GID=$(GID); docker compose up -d

## Para e remove containers, mantendo volumes
down:
	@echo "ğŸ›‘ Parando containers..."
	@docker compose down

## Para e remove tudo (containers, volumes e redes)
clean:
	@echo "ğŸ§¹ Removendo containers, volumes e redes..."
	@docker compose down -v
	@echo "ğŸ—‘ï¸  Limpando diretÃ³rios locais..."
	@sudo rm -rf $(VOLUMES)

## Corrige permissÃµes e cria diretÃ³rios de volume, se nÃ£o existirem
fix-perms:
	@echo "ğŸ”§ Corrigindo permissÃµes de volumes..."
	@for dir in $(VOLUMES); do \
		mkdir -p ./$$dir; \
		sudo chown -R $(USER):$(USER) ./$$dir; \
	done
	@echo "âœ… PermissÃµes corrigidas (usuÃ¡rio: $(USER))"

## Mostra o status dos containers
ps:
	@docker compose ps

## Mostra os logs em tempo real
logs:
	@docker compose logs -f

# =====================================
# ğŸ“˜ Ajuda (executar: make help)
# =====================================
help:
	@echo ""
	@echo "Comandos disponÃ­veis:"
	@echo "  make up         - Corrige permissÃµes e sobe os containers"
	@echo "  make down       - Para os containers (mantÃ©m volumes)"
	@echo "  make clean      - Remove containers, volumes e diretÃ³rios"
	@echo "  make fix-perms  - Corrige permissÃµes dos volumes"
	@echo "  make ps         - Mostra status dos containers"
	@echo "  make logs       - Mostra logs em tempo real"
	@echo ""
